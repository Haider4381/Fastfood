<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>FastFood POS ‚Äî POS Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="style.css" rel="stylesheet">
  <link href="nav.css" rel="stylesheet">
</head>
<body>
  <header class="topbar">
    <div class="brand-inline">
      <div class="logo small" aria-hidden="true">üçî</div>
      <strong>POS</strong>
    </div>
    <div class="topbar-actions">
      <a class="btn" href="dashboard.html">‚Üê Back</a>
      <button id="logoutBtn" class="btn danger">Logout</button>
    </div>
  </header>

  <!-- Full-width container -->
  <main class="container pos-wide">
    <section class="card">
      <h2 class="card-title">New/Open Order</h2>
      <div class="toolbar">
        <div class="inline">
          <label class="muted small">Order Type</label>
          <select id="orderType">
            <option value="TAKEAWAY">TAKEAWAY</option>
            <option value="DELIVERY">DELIVERY</option>
          </select>
        </div>
        <div class="inline">
          <label class="muted small">Customer Phone (optional)</label>
          <input type="text" id="custPhone" placeholder="03xxxxxxxxx">
        </div>
        <div class="inline">
          <label class="muted small">Branch ID</label>
          <input type="number" id="branchId" value="1" min="1" step="1" class="w-100px">
        </div>
        <button id="btnNewOrder" class="btn primary">Create New Order</button>

        <div class="inline">
          <label class="muted small">Order ID (internal)</label>
          <input type="text" id="currentOrderId" readonly placeholder="‚Äî" class="w-140">
        </div>

        <div class="inline">
          <label class="muted small">Ticket No (Order No)</label>
          <input type="text" id="currentTicketNo" readonly placeholder="‚Äî" class="w-180">
        </div>

        <button id="btnReset" class="btn">Reset</button>

        <!-- Reset Order No button -->
        <button id="btnResetSeq" class="btn danger" title="Reset daily order numbering to start from 1">Reset Order No</button>
      </div>
      <p id="orderMeta" class="muted small"></p>
    </section>

    <section class="pos-layout">
      <!-- Left: Items + Deals -->
      <div class="card">
        <div class="cat-bar" id="catBar"></div>

        <!-- Deals controls -->
        <div class="toolbar mb-8">
          <span class="pill">Deals</span>
          <button id="btnShowDeals" class="btn">Show Deals</button>
          <button id="btnBuildDeal" class="btn">Build Deal</button>
        </div>

        <div class="items-grid" id="itemsGrid"></div>
      </div>

      <!-- Right: Cart + Charges + Send to Kitchen -->
      <div class="card">
        <h3 class="card-title">Cart</h3>
        <div class="table-wrap">
          <table class="table cart-table" id="cartTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Item</th>
                <th class="num">Qty</th>
                <th class="num">Price</th>
                <th class="num">Disc</th>
                <th class="num">Line Total</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="cartBody"></tbody>
          </table>
        </div>

        <div class="grid mt-12">
          <div class="card">
            <h4 class="card-title">Charges</h4>
            <div class="form">
              <div class="form-row inline">
                <label>Service %</label>
                <input type="number" step="0.01" id="servicePct" placeholder="0" class="w-140">
              </div>
              <div class="form-row inline">
                <label>Tax %</label>
                <input type="number" step="0.01" id="taxPct" placeholder="0" class="w-140">
              </div>
              <div class="form-row inline">
                <label>Delivery Fee</label>
                <input type="number" step="0.01" id="deliveryFee" placeholder="0.00" class="w-140">
              </div>
              <button id="btnApplyCharges" class="btn">Apply Charges</button>
              <span id="chargesMsg" class="muted small"></span>
            </div>
          </div>

          <div class="card">
            <h4 class="card-title">Summary</h4>
            <div class="summary" id="summaryBox">
              <div class="line"><span>Subtotal</span><span id="sumSubtotal">0.00</span></div>
              <div class="line"><span>Discounts</span><span id="sumDiscount">0.00</span></div>
              <div class="line"><span>Service</span><span id="sumService">0.00</span></div>
              <div class="line"><span>Tax</span><span id="sumTax">0.00</span></div>
              <div class="line"><span>Delivery</span><span id="sumDelivery">0.00</span></div>
              <div class="line total"><span>Grand Total</span><span id="sumGrand">0.00</span></div>
              <div class="line"><span>Status</span><span id="sumStatus" class="badge">‚Äî</span></div>
            </div>

            <div class="toolbar mt-10">
              <button id="btnSendKitchen" class="btn primary">Send to Kitchen & Print</button>
              <button id="btnReprintKitchen" class="btn">Reprint Kitchen Slip</button>
              <button id="btnOpenBilling" class="btn">Open Billing</button>
              <a class="btn" href="orders.html">Orders ‚Üí</a>
              <span id="kitchenMsg" class="muted small"></span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Deal Builder Modal -->
  <div id="dealModal" class="modal" aria-hidden="true">
    <div class="panel">
      <div class="toolbar mb-8" style="justify-content:space-between">
        <h3 class="card-title">Deal Builder</h3>
        <button id="closeDealModal" class="btn">‚úï</button>
      </div>
      <div class="grid2">
        <div>
          <h4 class="card-title">Pick Items</h4>
          <div class="list-compact" id="dealPickList"></div>
        </div>
        <div>
          <h4 class="card-title">Your Deal</h4>
          <div class="form">
            <div class="form-row">
              <label>Deal Name</label>
              <input type="text" id="dealName" placeholder="e.g., Family Combo">
            </div>
            <div class="form-row">
              <label>Deal Price</label>
              <input type="number" step="0.01" id="dealPrice" placeholder="0.00">
            </div>
            <div class="form-row">
              <label>Deal Qty (when adding to order)</label>
              <input type="number" step="1" min="1" id="dealQty" value="1">
            </div>
            <div class="form-row">
              <button id="btnAddCustomDeal" class="btn primary">Save Deal</button>
              <span id="dealMsg" class="muted small"></span>
            </div>
          </div>
          <div class="mt-8">
            <div class="list-compact" id="dealChosenList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" hidden></div>

  <script src="app.js"></script>
  <script src="pos.js"></script>
  <script src="nav.js"></script>

  <script>
    function toastLocal(m, ok=true){
      const t = document.getElementById('toast');
      t.textContent = m;
      t.style.background = ok ? '#064e3b' : '#7f1d1d';
      t.hidden = false;
      setTimeout(()=> t.hidden = true, 1500);
    }

    (function bindKitchenFlow(){
      const btnSend = document.getElementById('btnSendKitchen');
      const btnBill = document.getElementById('btnOpenBilling');
      const btnReprint = document.getElementById('btnReprintKitchen');
      const msg = document.getElementById('kitchenMsg');
      const statusBadge = document.getElementById('sumStatus');
      const idInput = document.getElementById('currentOrderId');

      function getId(){
        const id = Number(idInput && idInput.value || 0);
        if (!id) { toastLocal('Create/Load order first', false); }
        return id;
      }

      if (btnSend) btnSend.addEventListener('click', async ()=>{
        const id = getId(); if (!id) return;
        try{
          msg.textContent = 'Checking...';
          const data = await apiFetch(`../api/orders/${id}`);
          const items = data.items || [];
          const status = (data.order?.status || '').toUpperCase();
          if (!items.length) {
            msg.textContent = '';
            toastLocal('Add items first', false);
            return;
          }
          if (status === 'KITCHEN') {
            msg.textContent = '';
            toastLocal('Already in kitchen ‚Äî printing...', true);
            window.open(`print/kitchen-slip.html?orderId=${id}`, '_blank');
            return;
          }
          msg.textContent = 'Sending...';
          await apiFetch(`../api/orders/${id}/send-to-kitchen`, { method: 'POST' });
          msg.textContent = '';
          if (statusBadge) statusBadge.textContent = 'KITCHEN';
          toastLocal('Sent to kitchen');
          window.open(`print/kitchen-slip.html?orderId=${id}`, '_blank');
        }catch(e){
          msg.textContent = (e && e.message) ? e.message : 'Failed';
        }
      });

      if (btnReprint) btnReprint.addEventListener('click', ()=>{
        const id = getId(); if (!id) return;
        window.open(`print/kitchen-slip.html?orderId=${id}`, '_blank');
      });

      if (btnBill) btnBill.addEventListener('click', ()=>{
        const id = getId(); if (!id) return;
        location.href = `billing.html?orderId=${id}`;
      });
    })();
  </script>
</body>
</html>