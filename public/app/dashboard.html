<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>FastFood POS ‚Äî Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="style.css?v=20251013-1" rel="stylesheet">
<link href="nav.css?v=20251013-1" rel="stylesheet">
</head>
<body>
  <header class="topbar">
    <div class="brand-inline">
      <div class="logo small" aria-hidden="true">üçî</div>
      <strong>FastFood POS ‚Äî Dashboard</strong>
    </div>
    <div class="topbar-actions">
      <span id="clock" class="muted" style="margin-right:12px">‚Äî</span>
      <span id="userInfo" class="muted"></span>
      <button id="logoutBtn" class="btn danger">Logout</button>
    </div>
  </header>

  <main class="container full">
    <section class="kpis">
      <div class="card">
        <div class="label">API Health</div>
        <div id="kpiHealth" class="k-value mono">‚Äî</div>
        <div id="kpiHealthNote" class="subtle">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">Active Menu Items</div>
        <div id="kpiItems" class="k-value">‚Äî</div>
        <div class="subtle">Loaded from menu</div>
      </div>
      <div class="card">
        <div class="label">Last Order Total</div>
        <div id="kpiLastOrder" class="k-value mono">‚Äî</div>
        <div class="subtle">Status: <span id="kpiLastStatus" class="pill">‚Äî</span></div>
      </div>
      <div class="card">
        <div class="label">User</div>
        <div id="kpiUser" class="k-value">‚Äî</div>
        <div id="kpiBranch" class="subtle">‚Äî</div>
      </div>
    </section>

    <section class="row mt-14">
      <div class="card">
        <div class="toolbar">
          <h3 class="card-title">Menu Snapshot</h3>
          <div class="actions">
            <button id="btnLoadMenu" class="btn">Reload</button>
            <a class="btn" href="menu.html">Manage ‚Üí</a>
          </div>
        </div>
        <div id="menuStatus" class="subtle">Loading...</div>
        <ul id="menuList" class="list"></ul>
      </div>

      <div class="card">
        <div class="toolbar">
          <h3 class="card-title">Recent Expenses</h3>
          <div class="actions">
            <button id="btnReloadExp" class="btn">Reload</button>
            <a class="btn" href="expenses.html">Open ‚Üí</a>
          </div>
        </div>
        <div id="expStatus" class="subtle">Loading...</div>
        <ul id="expList" class="list"></ul>
      </div>
    </section>

    <section class="card mt-14">
      <h3 class="card-title">Last Order Details</h3>
      <div class="toolbar mb-8">
        <button id="btnRefreshOrder" class="btn">Refresh</button>
        <button id="btnGoPOS" class="btn primary">Go to POS</button>
      </div>
      <pre id="orderOut" class="pre"></pre>
    </section>
  </main>

  <script src="app.js"></script>
  <script src="nav.js"></script>
  <script>
    (function ensureGlobals(){
      if (typeof apiFetch !== 'function') {
        window.apiFetch = async function(path, options = {}) {
          const res = await fetch(path, Object.assign({ credentials: 'same-origin' }, options));
          const txt = await res.text();
          let data = null;
          try { data = txt ? JSON.parse(txt) : null; } catch(_) { data = null; }
          if (!res.ok) {
            const msg = (data && (data.error || data.message)) || res.statusText || 'Request failed';
            throw new Error(msg);
          }
          return data;
        };
      }
      if (typeof goPublicRoot !== 'function') {
        window.goPublicRoot = function() {
          try {
            var p = location.pathname.replace(/[/\\]+/g,'/');
            var i = p.indexOf('/public/');
            if (i !== -1) { location.href = p.slice(0, i + '/public/'.length); return; }
            location.href = '/fastfoodpos/public/';
          } catch { location.href = '/fastfoodpos/public/'; }
        };
      }
    })();

    function toast(msg, ok = true) {
      const t = document.getElementById('toast');
      if (!t) return alert(msg);
      t.textContent = msg;
      t.style.background = ok ? '#064e3b' : '#7f1d1d';
      t.style.borderColor = ok ? '#10b98166' : '#ef444466';
      t.hidden = false;
      setTimeout(() => t.hidden = true, 2000);
    }
    function fmt(n){ return Number(n || 0).toFixed(2); }

    (function clockTick(){
      const el = document.getElementById('clock');
      if (el) el.textContent = new Date().toLocaleString();
      setTimeout(clockTick, 1000);
    })();

    const els = {
      userInfo: document.getElementById('userInfo'),
      logoutBtn: document.getElementById('logoutBtn'),
      qaMsg: document.getElementById('qaMsg'),
      kpiHealth: document.getElementById('kpiHealth'),
      kpiHealthNote: document.getElementById('kpiHealthNote'),
      kpiItems: document.getElementById('kpiItems'),
      kpiLastOrder: document.getElementById('kpiLastOrder'),
      kpiLastStatus: document.getElementById('kpiLastStatus'),
      kpiUser: document.getElementById('kpiUser'),
      kpiBranch: document.getElementById('kpiBranch'),
      menuStatus: document.getElementById('menuStatus'),
      menuList: document.getElementById('menuList'),
      btnLoadMenu: document.getElementById('btnLoadMenu'),
      expStatus: document.getElementById('expStatus'),
      expList: document.getElementById('expList'),
      btnReloadExp: document.getElementById('btnReloadExp'),
      btnRefreshOrder: document.getElementById('btnRefreshOrder'),
      btnGoPOS: document.getElementById('btnGoPOS'),
      orderOut: document.getElementById('orderOut'),
    };

    const state = { me: null };

    (async function init() {
      try {
        const me = await apiFetch('../api/me');
        if (!me || !me.user) throw new Error('Unauthorized');
        state.me = me.user;
        const branchTxt = state.me.branch_id ? ('Branch ' + state.me.branch_id) : 'No branch';
        if (els.userInfo) els.userInfo.textContent = state.me.name + ' (' + state.me.role + ')' + (state.me.branch_id ? ' | ' + branchTxt : '');
        if (els.kpiUser) els.kpiUser.textContent = state.me.name + ' (' + state.me.role + ')';
        if (els.kpiBranch) els.kpiBranch.textContent = branchTxt;
      } catch (e) {
        console.error('Session check failed:', e);
        toast('Session expired. Redirecting to login...', false);
        setTimeout(() => goPublicRoot(), 600);
        return;
      }
      await Promise.all([loadHealth(), loadMenu(), loadExpenses(), loadLastOrder()]);
    })();

    if (els.logoutBtn) els.logoutBtn.addEventListener('click', async () => {
      try { await apiFetch('../api/logout', { method: 'POST' }); } catch (_){}
      localStorage.removeItem('ffpos_user');
      goPublicRoot();
    });

    async function loadHealth(){
      try {
        const res = await apiFetch('../api/health');
        if (els.kpiHealth) {
          els.kpiHealth.textContent = res && res.ok ? 'OK' : 'DOWN';
          els.kpiHealth.classList.toggle('ok', !!res.ok);
          els.kpiHealth.classList.toggle('bad', !res.ok);
        }
        if (els.kpiHealthNote) els.kpiHealthNote.textContent = 'Last checked ' + new Date().toLocaleTimeString();
      } catch (e) {
        if (els.kpiHealth) { els.kpiHealth.textContent = 'DOWN'; els.kpiHealth.classList.remove('ok'); els.kpiHealth.classList.add('bad'); }
        if (els.kpiHealthNote) els.kpiHealthNote.textContent = e.message || 'error';
      }
    }

    async function loadMenu(){
      if (els.menuStatus) els.menuStatus.textContent = 'Loading...';
      if (els.menuList) els.menuList.innerHTML = '';
      try {
        const res = await apiFetch('../api/menu/items');
        const data = res.data || [];
        const active = data.filter(x => !!x.active);
        if (els.kpiItems) els.kpiItems.textContent = String(active.length);
        if (els.menuList) {
          active.slice(0, 8).forEach(row => {
            const li = document.createElement('li');
            li.innerHTML = '<span>' + (row.name) + ' <span class="pill">' + (row.category_name||'') + '</span></span>' +
                           '<span class="mono">' + Number(row.price).toFixed(2) + '</span>';
            els.menuList.appendChild(li);
          });
        }
        if (els.menuStatus) els.menuStatus.textContent = active.length ? ('Showing ' + Math.min(8, active.length) + ' of ' + active.length + ' active') : 'No active items';
      } catch (e) {
        if (els.menuStatus) els.menuStatus.textContent = 'Failed: ' + (e.message || '');
      }
    }
    if (els.btnLoadMenu) els.btnLoadMenu.addEventListener('click', loadMenu);

    async function loadExpenses(){
      if (els.expStatus) els.expStatus.textContent = 'Loading...';
      if (els.expList) els.expList.innerHTML = '';
      try {
        const res = await apiFetch('../api/expenses');
        const rows = res.data || [];
        if (els.expList) {
          rows.slice(0, 8).forEach(r => {
            const li = document.createElement('li');
            li.innerHTML =
              '<span>' + (r.category_name || 'Category') + ' <span class="pill">' + (r.branch_name || '') + '</span></span>' +
              '<span class="mono">' + Number(r.amount).toFixed(2) + '</span>';
            els.expList.appendChild(li);
          });
        }
        if (els.expStatus) els.expStatus.textContent = rows.length ? ('Showing ' + Math.min(8, rows.length) + ' recent') : 'No expenses';
      } catch (e) {
        if (els.expStatus) els.expStatus.textContent = 'Failed: ' + (e.message || '');
      }
    }
    if (els.btnReloadExp) els.btnReloadExp.addEventListener('click', loadExpenses);

    async function loadLastOrder(){
      let id = localStorage.getItem('ffpos_last_order_id');

      if (!id) {
        let latest = null;
        const tries = ['', 'PAID', 'READY', 'KITCHEN', 'OPEN', 'PARTIAL'];
        for (const st of tries) {
          try {
            const url = '../api/orders' + (st ? ('?status=' + encodeURIComponent(st) + '&limit=1') : '?limit=1');
            const res = await apiFetch(url);
            const rows = res?.data || [];
            if (rows.length) { latest = rows[0]; break; }
          } catch (_) {}
        }
        if (latest) {
          id = String(latest.id);
          localStorage.setItem('ffpos_last_order_id', id);
          if (els.kpiLastOrder) els.kpiLastOrder.textContent = Number(latest.grand_total).toFixed(2);
          if (els.kpiLastStatus) els.kpiLastStatus.textContent = latest.status;
          if (els.orderOut) els.orderOut.textContent = JSON.stringify({
            order_id: latest.id, order_no: latest.order_no, type: latest.order_type, status: latest.status,
            totals: { grand: latest.grand_total }
          }, null, 2);
          return;
        } else {
          if (els.kpiLastOrder) els.kpiLastOrder.textContent = '‚Äî';
          if (els.kpiLastStatus) els.kpiLastStatus.textContent = '‚Äî';
          if (els.orderOut) els.orderOut.textContent = 'No recent order';
          return;
        }
      }

      try {
        const data = await apiFetch('../api/orders/' + id);
        const o = data.order;
        if (els.kpiLastOrder) els.kpiLastOrder.textContent = Number(o.grand_total).toFixed(2);
        if (els.kpiLastStatus) els.kpiLastStatus.textContent = o.status;
        if (els.orderOut) els.orderOut.textContent = JSON.stringify({
          order_id: o.id, order_no: o.order_no, type: o.order_type, status: o.status,
          totals: { subtotal:o.subtotal, discount:o.discount_total, service:o.service_charge, tax:o.tax_total, delivery:o.delivery_fee, grand:o.grand_total }
        }, null, 2);
        localStorage.setItem('ffpos_last_order_id', String(o.id));
      } catch (e) {
        if (els.kpiLastOrder) els.kpiLastOrder.textContent = '‚Äî';
        if (els.kpiLastStatus) els.kpiLastStatus.textContent = '‚Äî';
        if (els.orderOut) els.orderOut.textContent = 'Failed to load last order: ' + (e.message || '');
      }
    }
    if (els.btnRefreshOrder) els.btnRefreshOrder.addEventListener('click', loadLastOrder);
    if (els.btnGoPOS) els.btnGoPOS.addEventListener('click', () => location.href = 'pos.html');
  </script>

  <div id="toast" class="toast" hidden></div>
</body>
</html>