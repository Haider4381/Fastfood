<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Customer Receipt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{ --paper-width:80mm; --font-size:13px; --line-height:1.35; --cell-pad:4px; --logo-width:240px; --border:#000; }
    html,body{background:#fff;color:#000}
    body{ margin:0;padding:0; font:var(--font-size)/var(--line-height) -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
    .paper{ width:var(--paper-width); margin:0 auto; padding:10px; }
    .brand{text-align:center;margin:0 0 4px}
    .brand .logo{ display:block;margin:0 auto 0;width:var(--logo-width);max-width:100%;height:auto;image-rendering:crisp-edges;image-rendering:-webkit-optimize-contrast }
    .brand .line{font-size:12px;font-weight:700}
    .hdr{border-bottom:2px solid var(--border);margin:4px 0 8px;padding-bottom:4px}
    .row{display:flex;justify-content:space-between;gap:8px}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{padding:var(--cell-pad) 0;border-bottom:1px dotted var(--border);word-break:break-word}
    .num{text-align:right}
    .section-title{margin:8px 0 4px 0;font-weight:700}
    .totals{margin-top:6px}
    .money{font-weight:700}
    .muted{color:#444}
    .rule{border-top:2px solid var(--border);margin:6px 0}
    .footer{margin-top:8px;text-align:center;font-size:11px}
    @media print{ .hint{display:none} }
  </style>
</head>
<body>
  <div class="paper">
    <div class="brand">
      <img class="logo" src="../assets/logo.png" alt="SNAZZ">
      <div class="line">Chota Manawala Main Bagawala Road Near Hussain Petroleum Faisalabad.</div>
      <div class="line">Phone: 0326-0030707</div>
    </div>

    <div class="hdr">
      <div class="row"><strong>Receipt</strong> <span id="when">—</span></div>
      <div class="row"><span id="meta">Order —</span> <span id="status">—</span></div>
    </div>

    <div class="section-title">Items</div>
    <table>
      <thead><tr><th>#</th><th>Item</th><th class="num">Qty</th><th class="num">Price</th><th class="num">Total</th></tr></thead>
      <tbody id="body"></tbody>
    </table>

    <div class="totals">
      <div class="row"><span>Subtotal</span><span id="tSub" class="num">0.00</span></div>
      <div class="row"><span>Discount</span><span id="tDisc" class="num">0.00</span></div>
      <div class="row"><span>Service</span><span id="tSvc" class="num">0.00</span></div>
      <div class="row"><span>Tax</span><span id="tTax" class="num">0.00</span></div>
      <div class="row"><span>Delivery</span><span id="tDel" class="num">0.00</span></div>
    </div>

    <div class="rule"></div>
    <div class="totals">
      <div class="row"><span>Grand Total</span><span id="tGrand" class="num money">0.00</span></div>
      <div class="row"><span>Received</span><span id="tRecv" class="num">0.00</span></div>
      <div class="row"><span>Change</span><span id="tChange" class="num">0.00</span></div>
    </div>

    <div class="footer muted">Software develop by Websofthouse (0300-7537538).</div>
  </div>

  <script src="../app.js"></script>
  <script>
    // 58mm support (optional)
    (function setupPaper(){
      const w = Number(new URLSearchParams(location.search).get('w') || 80);
      const is58 = (w === 58);
      const root = document.documentElement.style;
      root.setProperty('--paper-width', is58 ? '58mm' : '80mm');
      root.setProperty('--font-size', is58 ? '12px' : '13px');
      root.setProperty('--line-height', is58 ? '1.30' : '1.35');
      root.setProperty('--cell-pad', is58 ? '2px' : '4px');
      root.setProperty('--logo-width', is58 ? '180px' : '240px');
      const st = document.createElement('style');
      st.media = 'print';
      st.textContent = `@page{ size: ${is58 ? '58mm' : '80mm'} auto; margin: 2mm }`;
      document.head.appendChild(st);
    })();

    function num(v){ const n = parseFloat(v); return isFinite(n) ? n : 0; }
    function fmt(n){ return Number(n||0).toFixed(2); }

    (async function boot(){
      const qs = new URLSearchParams(location.search);
      const id = Number(qs.get('orderId')||0);
      // Typos ke liye fallbacks: recevied/recv, change/chg
      const qRecv = qs.get('received') ?? qs.get('recevied') ?? qs.get('recv');
      const qChange = qs.get('change') ?? qs.get('chg');
      if(!id){ alert('Missing orderId'); window.close(); return; }

      try{
        const d = await apiFetch('../../api/orders/'+id);
        const o = d.order, items = d.items||[], pays = d.payments||[];

        document.getElementById('when').textContent = new Date().toLocaleString();
        document.getElementById('meta').textContent = 'Order #' + o.id + ' (' + (o.order_no||'') + ')';
        document.getElementById('status').textContent = o.status;

        // Items
        const tb = document.getElementById('body');
        tb.innerHTML = '';
        items.forEach((it,i)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${i+1}</td><td>${it.item_name_snapshot}</td><td class="num">${Number(it.qty).toFixed(2)}</td><td class="num">${fmt(it.unit_price)}</td><td class="num">${fmt(it.line_total)}</td>`;
          tb.appendChild(tr);
        });

        // Totals (order se)
        document.getElementById('tSub').textContent = fmt(o.subtotal);
        document.getElementById('tDisc').textContent = fmt(o.discount_total);
        document.getElementById('tSvc').textContent = fmt(o.service_charge);
        document.getElementById('tTax').textContent = fmt(o.tax_total);
        document.getElementById('tDel').textContent = fmt(o.delivery_fee);
        document.getElementById('tGrand').textContent = fmt(o.grand_total);

        // Received/Change: query param > payments sum fallback
        const paid = pays.reduce((s,p)=> s + num(p.amount), 0);
        const received = (qRecv !== null && qRecv !== '') ? num(qRecv) : paid;
        const change = (qChange !== null && qChange !== '') ? num(qChange) : Math.max(0, received - num(o.grand_total));

        document.getElementById('tRecv').textContent = fmt(received);
        document.getElementById('tChange').textContent = fmt(change);

        setTimeout(()=>{ window.print(); setTimeout(()=>window.close(), 400); }, 150);
      }catch(e){
        alert('Failed: ' + (e.message||e));
      }
    })();
  </script>
</body>
</html>