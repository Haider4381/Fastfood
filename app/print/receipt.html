<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Receipt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      /* Will be set from query: ?w=80|58 and optional &pw=70 */
      --paper-width:80mm;      /* physical paper width */
      --content-width:72mm;    /* printable safe width inside paper */
      --fs:13px;               /* font size */
      --lh:1.38;               /* line height */
      --pad:3px;               /* cell vertical padding */
    }
    /* White page, black text */
    html,body{background:#fff;color:#000}
    body{
      margin:0;padding:0;
      font:var(--fs)/var(--lh) Arial,Helvetica,sans-serif;
      -webkit-print-color-adjust:exact; print-color-adjust:exact;
      -webkit-font-smoothing:none; font-smooth:never; text-rendering:optimizeSpeed;
    }

    /* Single table layout */
    table.receipt{
      width:var(--content-width);
      margin:0 auto;
      border-collapse:collapse;
      table-layout:fixed;      /* important to prevent overflow */
    }

    /* Column widths (mm) chosen to fit 72mm printable area by default */
    col.w-idx   { width: 9mm; }
    col.w-item  { width: auto; }
    col.w-qty   { width: 10mm; }
    col.w-price { width: 13mm; }
    col.w-total { width: 15mm; }

    th,td{
      padding:var(--pad) 0;
      word-break:break-word;
      overflow-wrap:anywhere;
      white-space:normal;
      letter-spacing:0.05px; /* helps on some thermal heads */
      vertical-align:top;
    }
    th{ font-weight:700; }

    .num{ text-align:right; }
    .center{ text-align:center; }
    .small{ font-size:12px; }

    /* Section separators (kept light to avoid over-burn) */
    .rule-top    { border-top:1px solid #111; }
    .rule-bottom { border-bottom:1px solid #111; }

    /* Keep rows intact on print */
    tr, td, th { page-break-inside: avoid; }

    @media print{
      /* Force exact paper width and no margins */
      @page{ size: var(--paper-width) auto; margin: 0; }
      body{ margin:0; }
    }
  </style>
</head>
<body>
  <table class="receipt" aria-label="Receipt">
    <colgroup>
      <!-- We will reuse widths for all rows; header rows span all columns -->
      <col class="w-idx">
      <col class="w-item">
      <col class="w-qty">
      <col class="w-price">
      <col class="w-total">
    </colgroup>

    <tbody id="hdr">
      <tr>
        <td colspan="5" class="center">
         <img class="logo" src="../assets/logo.png" alt="Logo"> <!--<h2 style="font-size: 28px;">SNAZZ FAST FOOD</h2>-->
        </td>
      </tr>
      <tr><td colspan="5" class="center"><strong>Chota Manawala Main Bagawala Road Near Hussain Petroleum Faisalabad.</strong></td></tr>
      <tr><td colspan="5" class="center small"><strong>Phone: 0326-0030707</strong></td></tr>
      <tr class="rule-bottom"><td colspan="5"></td></tr>

      <tr>
        <td colspan="3"><strong>Receipt</strong></td>
        <td colspan="2" class="num" id="when">—</td>
      </tr>
      <tr class="rule-bottom">
        <td colspan="4" id="meta">Order —</td>
        <td class="num" id="status">—</td>
      </tr>

      <tr><td colspan="5"><strong>Items</strong></td></tr>
      <tr class="rule-bottom">
        <th>#</th>
        <th>Item</th>
        <th class="num">Qty</th>
        <th class="num">Price</th>
        <th class="num">Total</th>
      </tr>
    </tbody>

    <tbody id="body">
      <!-- items injected here -->
    </tbody>

    <tbody id="totals">
      <tr class="rule-top"><td colspan="5"></td></tr>
      <tr><td colspan="4">Subtotal</td><td id="tSub" class="num">0.00</td></tr>
      <tr><td colspan="4">Discount</td><td id="tDisc" class="num">0.00</td></tr>
      <tr><td colspan="4">Service</td><td id="tSvc" class="num">0.00</td></tr>
      <tr><td colspan="4">Tax</td><td id="tTax" class="num">0.00</td></tr>
      <tr class="rule-bottom"><td colspan="4">Delivery</td><td id="tDel" class="num">0.00</td></tr>

      <tr>
        <td colspan="4"><strong>Grand Total</strong></td>
        <td id="tGrand" class="num"><strong>0.00</strong></td>
      </tr>
      <tr><td colspan="4">Received</td><td id="tRecv" class="num">0.00</td></tr>
      <tr class="rule-bottom"><td colspan="4">Change</td><td id="tChange" class="num">0.00</td></tr>
    </tbody>

    <tbody id="ftr">
      <tr><td colspan="5" class="center small">Software develop by Websofthouse (0300-7537538).</td></tr>
    </tbody>
  </table>

  <script>
    // Set paper width and safe printable content width from URL
    (function setupPaper(){
      const qs = new URLSearchParams(location.search);
      const w = Number(qs.get('w') || 80);          // 80 or 58
      const defaultPW = (w === 58) ? 48 : 72;       // safe printable width
      const pw = Number(qs.get('pw') || defaultPW); // override: &pw=70, etc.
      const is58 = (w === 58);

      const root = document.documentElement.style;
      root.setProperty('--paper-width', is58 ? '58mm' : '80mm');
      root.setProperty('--content-width', pw + 'mm');
      root.setProperty('--fs', is58 ? '12px' : '13px');
      root.setProperty('--lh', is58 ? '1.34' : '1.38');
      root.setProperty('--pad', is58 ? '2px' : '3px');

      // A second @page at runtime helps some browsers honor the size
      const st = document.createElement('style');
      st.media = 'print';
      st.textContent = `@page{ size: ${is58 ? '58mm' : '80mm'} auto; margin: 0 }`;
      document.head.appendChild(st);
    })();

    function num(v){ const n = parseFloat(v); return isFinite(n) ? n : 0; }
    function fmt(n){ return Number(n||0).toFixed(2); }

    async function apiFetch(path, options = {}) {
      const res = await fetch(path, Object.assign({ credentials: 'same-origin' }, options));
      const txt = await res.text();
      let data = null;
      try { data = txt ? JSON.parse(txt) : null; } catch(_) { data = null; }
      if (!res.ok) {
        const msg = (data && (data.error || data.message)) || res.statusText || 'Request failed';
        throw new Error(msg);
      }
      return data;
    }

    (async function boot(){
      const qs = new URLSearchParams(location.search);
      const id = Number(qs.get('orderId')||0);
      const qRecv = qs.get('received') ?? qs.get('recevied') ?? qs.get('recv');
      const qChange = qs.get('change') ?? qs.get('chg');
      if(!id){ alert('Missing orderId'); window.close(); return; }

      try{
        const d = await apiFetch('../../api/orders/'+id);
        const o = d.order, items = d.items||[], pays = d.payments||[];

        // Header lines
        document.getElementById('when').textContent = new Date().toLocaleString();
        document.getElementById('meta').textContent = 'Order #' + o.id + ' (' + (o.order_no||'') + ')';
        document.getElementById('status').textContent = (o.status||'').toUpperCase();

        // Items (sanitize names to remove hidden CR/LF)
        const tb = document.getElementById('body');
        tb.innerHTML = '';
        items.forEach((it,i)=>{
          const name = String(it.item_name_snapshot || '')
            .replace(/\r?\n/g,' ')
            .replace(/\s{2,}/g,' ')
            .trim();
          const tr = document.createElement('tr');
          tr.innerHTML =
            `<td>${i+1}</td>
             <td>${name}</td>
             <td class="num">${Number(it.qty).toFixed(2)}</td>
             <td class="num">${fmt(it.unit_price)}</td>
             <td class="num">${fmt(it.line_total)}</td>`;
          tb.appendChild(tr);
        });

        // Totals
        document.getElementById('tSub').textContent = fmt(o.subtotal);
        document.getElementById('tDisc').textContent = fmt(o.discount_total);
        document.getElementById('tSvc').textContent = fmt(o.service_charge);
        document.getElementById('tTax').textContent = fmt(o.tax_total);
        document.getElementById('tDel').textContent = fmt(o.delivery_fee);
        document.getElementById('tGrand').textContent = fmt(o.grand_total);

        // Received/Change: URL params override, else sum payments
        const paid = pays.reduce((s,p)=> s + num(p.amount), 0);
        const received = (qRecv !== null && qRecv !== '') ? num(qRecv) : paid;
        const change = (qChange !== null && qChange !== '') ? num(qChange) : Math.max(0, received - num(o.grand_total));
        document.getElementById('tRecv').textContent = fmt(received);
        document.getElementById('tChange').textContent = fmt(change);

        // Print once then close
        setTimeout(()=>{ window.print(); setTimeout(()=>window.close(), 400); }, 150);
      }catch(e){
        alert('Failed: ' + (e.message||e));
      }
    })();
  </script>
</body>
</html>