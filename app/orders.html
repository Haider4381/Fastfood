<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Orders â€” FastFood POS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="style.css" rel="stylesheet">
  <link href="nav.css" rel="stylesheet">
</head>
<body>
  <main class="container">
    <section class="card">
      <h2 class="card-title">Filter</h2>
      <div class="actions filters">
        <button class="btn" data-st="OPEN">Open</button>
        <button class="btn" data-st="KITCHEN">Kitchen</button>
        <button class="btn" data-st="READY">Ready</button>
        <button class="btn" data-st="PAID">Paid</button>
        <button class="btn" data-st="PARTIAL">Partial</button>
        <span id="msg" class="muted small"></span>
      </div>
    </section>

    <section class="card">
      <h3 class="card-title">Orders</h3>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>No</th>
              <th>Phone</th>
              <th>Type</th>
              <th>Status</th>
              <th class="num">Grand</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="body"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script src="app.js"></script>
  <script src="nav.js"></script>
  <script>
    const ui = { msg: document.getElementById('msg'), body: document.getElementById('body') };
    let currentSt = 'KITCHEN';

    function setActiveFilter(){
      document.querySelectorAll('[data-st]').forEach(b=>{
        b.classList.toggle('active', b.dataset.st === currentSt);
      });
    }

    async function loadList(){
      ui.msg.textContent = 'Loading...';
      ui.body.innerHTML = '';
      setActiveFilter();
      try{
        const res = await apiFetch(`../api/orders?status=${encodeURIComponent(currentSt)}&limit=200`);
        const rows = res.data || [];
        rows.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.id}</td>
            <td>${r.order_no || ''}</td>
            <td>${r.customer_phone || ''}</td>
            <td>${r.order_type}</td>
            <td>${r.status}</td>
            <td class="num">${Number(r.grand_total||0).toFixed(2)}</td>
            <td>${(r.created_at||'').replace('T',' ').replace('Z','')}</td>
            <td class="row-actions">
              <button class="btn" data-act="edit">Edit</button>
              <button class="btn" data-act="bill">Billing</button>
              <button class="btn" data-act="kprint">Kitchen Slip</button>
              <button class="btn danger" data-act="cancel">Delete</button>
            </td>
          `;
          tr.querySelectorAll('button').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const act = btn.dataset.act;
              if (act === 'edit') {
                location.href = `pos.html?orderId=${r.id}`;
              } else if (act === 'bill') {
                location.href = `billing.html?orderId=${r.id}`;
              } else if (act === 'kprint') {
                window.open(`print/kitchen-slip.html?orderId=${r.id}`, '_blank');
              } else if (act === 'cancel') {
                if (!confirm('Cancel this order? Only OPEN orders without payments can be cancelled.')) return;
                try {
                  await apiFetch(`../api/orders/${r.id}/cancel`, { method:'POST' });
                  loadList();
                } catch(e) {
                  alert(e.message || 'Failed to cancel');
                }
              }
            });
          });
          ui.body.appendChild(tr);
        });
        ui.msg.textContent = rows.length ? `Loaded ${rows.length}` : 'No orders';
      }catch(e){
        ui.msg.textContent = e.message || 'Failed';
      }
    }

    document.querySelectorAll('[data-st]').forEach(b=>{
      b.addEventListener('click', ()=>{ currentSt = b.dataset.st; loadList(); });
    });

    loadList();
  </script>
</body>
</html>