<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Sale Bill ‚Äî FastFood POS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="style.css" rel="stylesheet">
  <link href="nav.css" rel="stylesheet">
</head>
<body>
  <header class="topbar">
    <div class="brand-inline">
      <div class="logo small" aria-hidden="true">üçî</div>
      <strong>Sale Bill</strong>
    </div>
    <div class="topbar-actions">
      <a class="btn" href="orders.html">‚Üê Orders</a>
      <a class="btn" href="dashboard.html">Dashboard</a>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h2 class="card-title">Find Order</h2>
      <div class="actions">
        <input type="number" id="orderId" placeholder="Order ID" class="w-160">
        <button id="btnLoad" class="btn">Load</button>
        <span id="msg" class="muted small"></span>
      </div>
    </section>

    <section class="card">
      <h3 class="card-title">Order</h3>
      <div class="actions">
        <span class="pill">No: <span id="oNo">‚Äî</span></span>
        <span class="pill">Type: <span id="oType">‚Äî</span></span>
        <span class="pill">Status: <span id="oStatus">‚Äî</span></span>
        <span class="pill mono">Grand: <span id="oGrand">0.00</span></span>
        <span class="pill mono">Paid: <span id="oPaid">0.00</span></span>
        <span class="pill mono">Remaining: <span id="oRemain">0.00</span></span>
        <button id="btnPrintReceipt" class="btn">Print Receipt</button>
      </div>
      <div class="table-wrap mt-8">
        <table class="table">
          <thead>
            <tr><th>#</th><th>Item</th><th class="num">Qty</th><th class="num">Price</th><th class="num">Total</th></tr>
          </thead>
          <tbody id="items"></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h3 class="card-title">Payment</h3>
      <div class="grid-2 gap-10">
        <div>
          <label>Method</label>
          <select id="method">
            <option value="CASH">CASH</option>
            <option value="CARD">CARD</option>
            <option value="WALLET">WALLET</option>
            <option value="QR">QR</option>
          </select>
        </div>
        <div>
          <label>Amount Received</label>
          <input id="amount" class="mono" type="number" step="0.01" placeholder="0.00">
        </div>
      </div>
      <div class="actions mt-8">
        <input id="reference" type="text" placeholder="Reference (optional)" class="w-220">
        <button id="btnSaveBill" class="btn primary">Save Bill</button>
        <span id="payMsg" class="muted small"></span>
        <span class="pill mono" id="pillApply" hidden>Apply: 0.00</span>
        <span class="pill mono" id="pillChange" hidden>Change: 0.00</span>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" hidden></div>

  <script src="app.js"></script>
  <script src="nav.js"></script>
  <script>
    const ui = {
      orderId: document.getElementById('orderId'),
      btnLoad: document.getElementById('btnLoad'),
      msg: document.getElementById('msg'),

      oNo: document.getElementById('oNo'),
      oType: document.getElementById('oType'),
      oStatus: document.getElementById('oStatus'),
      oGrand: document.getElementById('oGrand'),
      oPaid: document.getElementById('oPaid'),
      oRemain: document.getElementById('oRemain'),

      items: document.getElementById('items'),

      method: document.getElementById('method'),
      amount: document.getElementById('amount'),
      reference: document.getElementById('reference'),
      btnSaveBill: document.getElementById('btnSaveBill'),
      payMsg: document.getElementById('payMsg'),

      pillApply: document.getElementById('pillApply'),
      pillChange: document.getElementById('pillChange'),

      btnPrint: document.getElementById('btnPrintReceipt'),
      toast: document.getElementById('toast'),
    };

    function toast(msg, ok = true) {
      if (!ui.toast) { alert(msg); return; }
      ui.toast.textContent = msg;
      ui.toast.style.background = ok ? '#064e3b' : '#7f1d1d';
      ui.toast.hidden = false;
      setTimeout(() => ui.toast.hidden = true, 1500);
    }
    function fmt(n){ return Number(n || 0).toFixed(2); }

    let current = null;
    let amounts = { paid: 0, remain: 0, grand: 0 };

    async function loadOrder(id){
      if (ui.msg) ui.msg.textContent = 'Loading...';
      try {
        const data = await apiFetch('../api/orders/' + id);
        current = data;
        const o = data.order;
        const paid = (data.payments || []).reduce((s,p)=> s + Number(p.amount||0), 0);
        const remain = Math.max(0, Number(o.grand_total) - paid);

        amounts = { paid, remain, grand: Number(o.grand_total||0) };

        if (ui.oNo) ui.oNo.textContent = o.order_no || o.id;
        if (ui.oType) ui.oType.textContent = o.order_type;
        if (ui.oStatus) ui.oStatus.textContent = o.status;
        if (ui.oGrand) ui.oGrand.textContent = fmt(o.grand_total);
        if (ui.oPaid) ui.oPaid.textContent = fmt(paid);
        if (ui.oRemain) ui.oRemain.textContent = fmt(remain);

        if (ui.items) {
          ui.items.innerHTML = '';
          (data.items || []).forEach((it, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${i+1}</td>
              <td>${it.item_name_snapshot}</td>
              <td class="num">${Number(it.qty).toFixed(2)}</td>
              <td class="num">${fmt(it.unit_price)}</td>
              <td class="num">${fmt(it.line_total)}</td>
            `;
            ui.items.appendChild(tr);
          });
        }

        if (ui.amount) ui.amount.value = fmt(remain);
        previewChange();
        if (ui.msg) ui.msg.textContent = '';
      } catch (e) {
        if (ui.msg) ui.msg.textContent = e.message || 'Failed';
      }
    }

    function previewChange(){
      if (!ui.amount) return;
      const received = Number(ui.amount.value || 0);
      const remain = Number(amounts.remain || 0);
      const apply = Math.max(0, Math.min(received, remain));
      const change = Math.max(0, received - remain);
      if (ui.pillApply) {
        ui.pillApply.textContent = 'Apply: ' + fmt(apply);
        ui.pillApply.hidden = !(received > 0);
      }
      if (ui.pillChange) {
        ui.pillChange.textContent = 'Change: ' + fmt(change);
        ui.pillChange.hidden = !(received > remain);
      }
    }

    if (ui.amount) ui.amount.addEventListener('input', previewChange);

    if (ui.btnLoad) {
      ui.btnLoad.addEventListener('click', () => {
        const id = Number(ui.orderId && ui.orderId.value || 0);
        if (!id) return toast('Enter order ID', false);
        loadOrder(id);
      });
    }

    if (ui.btnSaveBill) {
      ui.btnSaveBill.addEventListener('click', async () => {
        try {
          if (!current || !current.order) return toast('Load order first', false);
          const o = current.order;

          const received = Number(ui.amount && ui.amount.value || 0);
          if (!isFinite(received) || received <= 0) {
            toast('Enter amount received', false);
            return;
          }
          const remainBefore = Number(amounts.remain || 0);
          const apply = Math.max(0, Math.min(received, remainBefore));
          const change = Math.max(0, received - remainBefore);

          if (apply > 0) {
            if (ui.payMsg) ui.payMsg.textContent = 'Saving...';
            ui.btnSaveBill.disabled = true;

            await apiFetch(`../api/orders/${o.id}/pay`, {
              method: 'POST',
              body: JSON.stringify({
                method: (ui.method && (ui.method.value || 'CASH').toUpperCase()) || 'CASH',
                amount: apply,
                reference: ui.reference ? (ui.reference.value.trim() || null) : null
              })
            });

            if (ui.payMsg) ui.payMsg.textContent = '';
            toast('Bill saved');
            await loadOrder(o.id);
            ui.btnSaveBill.disabled = false;
          }

          const url = `print/receipt.html?orderId=${o.id}&received=${encodeURIComponent(received.toFixed(2))}&change=${encodeURIComponent(change.toFixed(2))}`;
          window.open(url, '_blank');

        } catch (e) {
          if (ui.payMsg) ui.payMsg.textContent = e.message || 'Failed';
          ui.btnSaveBill.disabled = false;
        }
      });
    }

    if (ui.btnPrint) {
      ui.btnPrint.addEventListener('click', () => {
        if (!current || !current.order) return toast('Load order first', false);
        window.open(`print/receipt.html?orderId=${current.order.id}`, '_blank');
      });
    }

    (function bootFromQuery(){
      const id = Number(new URLSearchParams(location.search).get('orderId') || 0);
      if (id) {
        if (ui.orderId) ui.orderId.value = String(id);
        loadOrder(id);
      }
    })();
  </script>
</body>
</html>